# Pre-commit Setup

This project uses [pre-commit](https://pre-commit.com/) to run linters and tests before commits.

## Installation

### 1. Install pre-commit

**Using pip:**
```bash
pip install pre-commit
```

**Using Homebrew (macOS):**
```bash
brew install pre-commit
```

**Using conda:**
```bash
conda install -c conda-forge pre-commit
```

### 2. Install the git hook scripts

In the project root directory:
```bash
pre-commit install
```

### 3. (Optional) Run against all files

To run pre-commit against all files (not just staged changes):
```bash
pre-commit run --all-files
```

## What Gets Checked

The pre-commit hooks run the following checks:

### General Checks
- Remove trailing whitespace
- Fix end of files
- Check YAML syntax
- Prevent large files from being committed
- Check for merge conflicts
- Check for case conflicts
- Fix mixed line endings

### Go-specific Checks
- **go fmt**: Format Go code
- **go vet**: Examine Go source code and report suspicious constructs
- **go imports**: Update Go import lines
- **go unit tests**: Run all unit tests with race detection
- **go build**: Build the project
- **go mod tidy**: Ensure go.mod matches source code

### Linting
- **golangci-lint**: Run comprehensive Go linters

## Skipping Hooks

If you need to skip the pre-commit hooks for a specific commit:
```bash
git commit --no-verify
```

**Note:** This should only be used in exceptional circumstances, as it bypasses all quality checks.

## Updating Hooks

To update the pre-commit hooks to their latest versions:
```bash
pre-commit autoupdate
```

## Troubleshooting

### Parser generation required

If you see errors about missing parser files, generate them first:
```bash
go install golang.org/x/tools/cmd/goyacc@latest
export PATH=$PATH:$(go env GOPATH)/bin
goyacc -o parser/y.go -p yy parser/classad.y
```

### Hooks fail to run

If the hooks fail to install or run:
1. Ensure you have Go 1.21 or later installed
2. Ensure your `GOPATH/bin` is in your `PATH`
3. Try reinstalling the hooks: `pre-commit clean && pre-commit install`
